### 网吧项目实现方案 V1（基于原型与功能表）

- **目标**：构建覆盖门店端设备监控/计费、用户端小程序下单与互动、商家端运营、3D 实景导览与互动、数据统计以及公众号服务的完整系统，并可与现有收银/计费系统对接。
- **范围**：原型表所列“核心监控系统、3D 实景、后台管理、用户端小程序、商家端小程序、公众号服务”。

## 一、总体架构
- **边缘端（门店）**：
  - 设备 Agent（Windows/主机）：采集在线/离线、CPU/内存/硬盘、当前进程/游戏、网络、温度等；支持远程控制（锁屏、重启、应用拉起）、心跳与命令下发。
  - IoT 网关（MQTT）：Agent 通过 MQTT 与云端交互，支持批量下发与回执。
- **云端平台**：
  - 应用服务（Auth、订单、计费、支付、库存/座位、评价、积分、消息、风控、商家权限）
  - 监控服务（Telemetry Ingest、规则引擎、告警、看板）
  - 计费与对账服务（余额、充值、退款、账单、对接第三方收银）
  - 3D 实景服务（场景配置、热点、路径、排行榜）
  - 数据仓库/报表（明细与汇总，多维统计）
  - 消息总线/异步任务（MQ、定时任务、Webhook）
- **前端应用**：
  - 用户端小程序（下单、余额、拼桌/分时、评论、活动、排行榜、好友、消息）
  - 商家端小程序（新订单提醒、确认/拒绝、优惠发布、退款、权限、异常提醒）
  - 后台管理 Web（运营与数据、设备与地图、3D 场景配置、权限）
  - 公众号（基础服务、消息自动化、会员绑定）

## 二、关键模块与功能映射
- **核心监控系统**
  - 机器状态监控：在线/离线、硬件资源、网络、异常事件
  - 游戏/应用识别：进程白/黑名单、会话时长、热度榜单
  - 用户行为追踪：上机时长、消费路径、偏好画像
- **3D 实景**
  - 交互：多楼层/区域、热点讲解、路径导航、排行榜
  - 动态状态渲染：座位占用、机器状态、游戏标签
  - 公开展示：H5/小程序 WebView 嵌入、活动路由
- **后台管理**
  - 数据统计：上座率、营收、游戏偏好、设备健康度
  - 机器记录：维修/更换/巡检记录
- **小程序（用户端）**
  - 账户注册/登录（手机号/微信）与余额/充值（微信/支付宝）
  - 订单：下单（选区/选座/时段），取消/退款，状态同步
  - 分时计价/拼桌、活动优惠、评价/投诉、排行榜/积分、好友/消息
  - 自定义规则：黑名单、抵扣时长、结算租赁费用（如对接计费）
- **小程序（商家端）**
  - 实时订单处理（新订单提醒、确认/拒绝）
  - 商家推送（新活动/赛事/涨跌价）、活动发布与生效控制
  - 机器遥控（开/关机、解锁、拉起游戏）、库存/限量
  - 退款管理、员工角色与权限（与收银系统权限打通）
  - 异常提醒（硬件/网络/温度/心跳）、远程排障指引
- **公众号功能**
  - 基础服务（营业展示、实时机器/座位/地址/营业时间）
  - 消息自动化（模板消息/客服消息、常见问答）
  - 会员绑定与权益同步（余额、积分、成长体系）

## 三、技术栈建议
- 前端：
  - 微信小程序：Taro 或原生小程序（TypeScript + Zustand/MobX）
  - 后台 Web：React + Ant Design Pro + Vite（TypeScript）
  - 3D：three.js（H5）+ 小程序 WebView 嵌入；场景编辑器后端维护热点/路径
- 后端：NestJS（Node.js, TypeScript）或 Spring Boot（Java）。本文以 NestJS 为主推。
- 数据库：PostgreSQL（交易一致性）、Redis（会话与缓存）、ClickHouse（行为/日志明细，可选）
- 消息与 IoT：EMQX/Mosquitto（MQTT），RabbitMQ（异步任务/通知）
- 可观测：Prometheus + Grafana、Loki、Sentry
- 部署：Kubernetes 或 Docker Compose（单店/多店可拓展），对象存储（图片/日志归档）

## 四、设备 Agent 设计
- 运行环境：Windows 服务（Go/.NET 6），守护进程，自动升级
- 能力：
  - 采集：CPU/内存/磁盘/温度/网络、当前前台进程、在线状态
  - 控制：锁屏/解锁、开关机脚本、拉起/关闭应用、限速、消息弹窗
  - 安全：签名校验、设备绑定、令牌轮换、命令回执、防篡改
  - 通道：MQTT 主通道 + HTTPS 兜底上报

## 五、计费与支付
- 余额账户：可充值、消费、退款；交易型流水（不可变更）
- 计费：分时/包时/活动价；支持抵扣券、积分、抵扣时长
- 支付：微信/支付宝统一抽象；异步通知与对账；异常单重试
- 与收银系统对接：
  - 事件：下单、开始/结束上机、结算、退款、会员变更
  - 方式：Webhook + 签名、或轮询/SDK；失败重试与补偿

## 六、数据模型（草案）
- 主体：`User`、`Merchant`、`Store`、`Zone`、`Seat`、`Device`、`Game`、`Order`、`OrderItem`、`Session`、`Payment`、`Refund`、`BalanceTxn`、`Promotion`、`Review`、`Message`、`Notification`
- 关系要点：
  - `Store` 下含 `Zone`、`Seat`、`Device`；`Seat` 与 `Device` 一对一绑定
  - `Order` 关联 `User` 与 `Seat/Zone`，`Session` 记录上机区间
  - `Payment/Refund/BalanceTxn` 形成完整资金链路

## 七、接口（初稿清单）
- Auth：微信登录、手机号一键登录、绑定/解绑
- 用户：余额、充值、订单 CRUD、拼桌、评价、收藏、消息
- 商家：订单处理、退款、活动、库存与限量、员工与权限
- 设备：心跳/遥测上报、命令下发、控制回执、固件升级
- 3D：场景/热点/路径、占用态查询、排行榜
- 统计：门店看板、游戏热度、设备健康度、资金报表

## 八、里程碑与排期（建议）
- M1（2-3 周）：账户/订单/支付最小闭环 + 设备 Agent 心跳/上报 + 简易看板
- M2（2 周）：选区/选座/分时计价 + 下单支付 + 门店端处理
- M3（2 周）：退款/对账/活动 + 商家权限与员工端
- M4（2-3 周）：3D 场景 MVP（占用态 + 导航 + 热点）
- M5（1-2 周）：数据统计与报表 + 告警
- M6（1 周）：公众号接入与消息自动化

## 九、风险与合规
- 门店实名/公安联网（若适用当地法规），上网日志留存
- 设备安全与防作弊、防恶意软件
- 高峰期并发与库存超卖、支付幂等
- 与存量收银系统的数据一致性与回放能力

## 十、验收标准（MVP）
- 用户可在小程序完成选座/下单/支付，设备端自动解锁开始上机
- 商家端可处理订单、退款，查看基础看板
- 设备与场景占用态实时可视化，异常有告警

> 注：3D 场景与楼层示意参见原型图（待补至 `docs/prototypes/`）。