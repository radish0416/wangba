# 网吧系统-总体设计与实现方案-第1版

版本: v1.0  分支: docs  文件位置: `docs/网吧系统-总体设计与实现方案-第1版.md`

## 1. 目标与范围
- 面向对象: 网吧消费者(用户小程序)、网吧商家(后台Web)、运维人员(后台Web)
- 范围排除: 设备监控与支付模块仅做接口对接，不做自研
- 运行环境: Windows + Docker 部署
- 技术栈: 后端 Java Spring Boot(单体架构)、MySQL、Redis、MinIO、微信小程序前端、Element-UI 风格 Web 管理台

## 2. 整体架构与模块
- 核心域: 订单与计费、座位/机位管理、活动/优惠、账户与余额、消费记录、统计报表
- 支撑域: 权限与认证、文件与3D资源存储(MinIO)、缓存(会话/热点数据)、消息通知
- 集成域: 第三方设备监控平台、第三方支付平台(微信/支付宝)、微信生态(登录/订阅消息)

目录结构建议(单体后端):
```
server
 ├─ src/main/java/com/cybercafe
 │   ├─ auth (登录鉴权、RBAC)
 │   ├─ user (用户/商家/员工)
 │   ├─ seat (区域/机位/状态/锁定)
 │   ├─ order (下单/续费/扣费/结算)
 │   ├─ billing (计费策略、套餐、活动优惠)
 │   ├─ wallet (余额/充值/退款/流水)
 │   ├─ content (公告/轮播/评价/社区)
 │   ├─ stats (经营看板/数据统计)
 │   ├─ storage (MinIO封装)
 │   ├─ integration (支付、设备监控对接)
 │   └─ common (异常/配置/基础设施)
 └─ src/main/resources
```

## 3. 核心流程概览
- 登录注册(小程序/后台)
- 选区选座 -> 下单 -> 计费计时 -> 续费/加购 -> 扣费/结算 -> 评价
- 充值/退款/余额同步(对接支付)
- 商家排班、开关机位、订单管理、活动配置、看板统计

关联图表:
- 业务流程图: `docs/diagrams/flow-main.svg`
- 项目架构图: `docs/diagrams/arch-overview.svg`
- 数据库ER图: `docs/diagrams/er-model.svg`

## 4. 数据模型(摘要，完整见ER图)
- 用户: 用户基本信息、微信标识、账户状态
- 商家与员工: 门店、员工、角色权限
- 机位与区域: 区域、机位、状态(空闲/占用/维护/锁定)
- 订单与计费: 订单、订单项、计费策略、优惠券、活动
- 钱包与交易: 账户余额、充值/扣费/退款流水(支付单号对接)
- 内容互动: 公告、评价、话题/评论

命名规范: 数据库字段一律小驼峰; 统一`id`为雪花或自增; 软删统一`isDeleted`。

## 5. 接口设计(概要)
- 认证: `/api/auth/login`, `/api/auth/logout`, `/api/auth/wxLogin`
- 选座: `/api/seats/areas`, `/api/seats/{id}`(状态/锁定/释放)
- 下单/计费: `/api/orders`(POST创建)、`/api/orders/{id}/renew`、`/api/orders/{id}/settle`
- 钱包: `/api/wallet/balance`, `/api/wallet/recharge`(支付预下单)、`/api/wallet/refund`
- 活动: `/api/campaigns`, `/api/coupons`
- 统计: `/api/stats/dashboard`
- 文件: `/api/files/upload`(MinIO直传)

## 6. 非功能性要求
- 性能: 常用查询命中Redis; 热点座位状态采用短TTL缓存+订阅失效
- 安全: RBAC、数据行级隔离(按门店/商家)、敏感字段脱敏、签名验签
- 可观测: 统一日志、审计日志、关键链路打点; 健康检查端点

## 7. 3D 网吧页面(小程序)
- 资源: 3D模型/贴图存储MinIO; 小程序使用WebGL/threejs(或引擎插件)加载
- 功能: 俯视导航、区域高亮、机位状态颜色、点选下单、路径引导
- 性能: 按区域懒加载、贴图压缩、阴影简化、动画帧率限制

## 8. 部署与运行
- Docker 化: server、mysql、redis、minio 四容器; Windows 下 docker-compose 一键启动
- 配置: `.env` 管理连接串与密钥; 生产禁用Swagger公开

## 9. 原型与文件规范
- Web(参照 Element-UI): 放置于 `docs/wireframes/web-element`
- 小程序(参照 Figma 风格): 放置于 `docs/wireframes/miniapp-figma`
- 图形文件一律使用 SVG 矢量可视化(可预览与版本控制友好)

## 10. 里程碑
1) v0.1 原型与设计完备(本文件与三图、两类原型)
2) v0.2 后端骨架、数据库初始化、基础登录与选座读写
3) v0.3 下单计费联调、3D加载与点选
4) v1.0 对接支付与设备监控(回调/状态同步)、上线

—— 完 ——

